-- Shadow Script | Lite

if not game:IsLoaded() then game.Loaded:Wait() end

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local SoundService = game:GetService("SoundService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local workspace = game:GetService("Workspace")
local TeleportService = game:GetService("TeleportService")

local player = Players.LocalPlayer

-- Remote события для автофарма
local CoinCollected = ReplicatedStorage.Remotes.Gameplay.CoinCollected
local RoundStart = ReplicatedStorage.Remotes.Gameplay.RoundStart
local RoundEnd = ReplicatedStorage.Remotes.Gameplay.RoundEndFade

-- Кэширование часто используемых значений
local COLORS = {
    BACKGROUND = Color3.fromRGB(20, 20, 20),
    ACCENT = Color3.fromRGB(70, 130, 255),
    TEXT = Color3.fromRGB(200, 200, 220),
    CONTAINER = Color3.fromRGB(30, 30, 40),
    TOGGLE_OFF = Color3.fromRGB(60, 60, 80),
    TOGGLE_ON = Color3.fromRGB(70, 130, 255),
    STROKE_OFF = Color3.fromRGB(100, 100, 120),
    STROKE_ON = Color3.fromRGB(100, 160, 255),
    DOT = Color3.fromRGB(220, 220, 240),
    HOVER = Color3.fromRGB(70, 70, 90)
}

local UDIM = {
    TITLE_POS = UDim2.new(0, 10, 0, 5),
    LABEL_POS = UDim2.new(0, 10, 0, 0),
    TOGGLE_POS = UDim2.new(0.72, 0, 0.175, 0),
    TOGGLE_SIZE = UDim2.new(0.25, 0, 0.65, 0),
    DOT_POS_OFF = UDim2.new(0.05, 0, 0.15, 0),
    DOT_POS_ON = UDim2.new(0.5, 0, 0.15, 0),
    DOT_SIZE = UDim2.new(0.45, 0, 0.7, 0)
}

-- Константы для Anti-AFK
local ANTI_AFK_SETTINGS = {
    INACTIVITY_THRESHOLD = 600,
    CHECK_INTERVAL = 5,
    SPACE_PRESS_DURATION = 0.2,
    DEBOUNCE_TIME = 1
}

-- Константы для Auto Farm (из первого кода)
local AUTO_FARM_SETTINGS = {
    TELEPORT_DISTANCE = 150,
    MOVE_SPEED_DIVIDER = 20, -- Из первого кода: dist / 20
    CHECK_INTERVAL = 0.2,
    COIN_SEARCH_RADIUS = math.huge
}

-- Константы для Auto Reset (из первого кода)
local AUTO_RESET_SETTINGS = {
    RETURN_DURATION = 2,
    RETURN_WAIT = 0.5,
    RESPAWN_WAIT = 1.5
}

-- ID звука для нажатий
local CLICK_SOUND_ID = 9083627113

-- Кэшированные анимации
local TWEEN_INFO = {
    FAST = TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    STANDARD = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
    SMOOTH = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
}

-- =========================
-- Sound Functions
-- =========================

local clickSound = nil
local soundDebounce = false

-- Функция создания и воспроизведения звука
local function playClickSound()
    if soundDebounce then return end
    soundDebounce = true
    
    clickSound = Instance.new("Sound")
    clickSound.SoundId = "rbxassetid://" .. CLICK_SOUND_ID
    clickSound.Volume = 0.5
    clickSound.Parent = SoundService
    
    clickSound:Play()
    
    game:GetService("Debris"):AddItem(clickSound, 5)
    
    task.delay(0.1, function()
        soundDebounce = false
    end)
end

-- =========================
-- Reusable Functions
-- =========================

-- Оптимизированная функция создания UI элементов
local function createElement(className, properties)
    local element = Instance.new(className)
    for prop, value in pairs(properties) do
        if type(value) == "table" and value.ClassName then
            value.Parent = element
        else
            element[prop] = value
        end
    end
    return element
end

-- Создание контейнера с общими стилями
local function createContainer(name, parent, position)
    local container = createElement("Frame", {
        Name = name .. "Container",
        Parent = parent,
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = COLORS.CONTAINER,
        BackgroundTransparency = 0.7,
        BorderSizePixel = 0
    })
    
    createElement("UICorner", {
        Parent = container,
        CornerRadius = UDim.new(0, 8)
    })
    
    createElement("UIStroke", {
        Parent = container,
        Color = Color3.fromRGB(50, 50, 70),
        Thickness = 1,
        Transparency = 0.3
    })
    
    return container
end

-- Создание переключателя с звуком
local function createToggle(parent, name, labelText)
    local frame = createElement("Frame", {
        Name = name .. "Frame",
        Parent = parent,
        BackgroundTransparency = 1,
        Size = UDim2.new(1, -20, 0, 35)
    })
    
    local container = createContainer(name, frame, UDim2.new(0, 0, 0, 0))
    
    createElement("TextLabel", {
        Name = name .. "Label",
        Parent = container,
        BackgroundTransparency = 1,
        Size = UDim2.new(0.7, 0, 1, 0),
        Position = UDIM.LABEL_POS,
        Text = labelText,
        TextColor3 = COLORS.TEXT,
        TextSize = 14,
        Font = Enum.Font.Gotham,
        TextXAlignment = Enum.TextXAlignment.Left
    })
    
    local toggleButton = createElement("TextButton", {
        Name = name .. "Toggle",
        Parent = container,
        Size = UDIM.TOGGLE_SIZE,
        Position = UDIM.TOGGLE_POS,
        BackgroundColor3 = COLORS.TOGGLE_OFF,
        Text = "",
        AutoButtonColor = false,
        ZIndex = 2
    })
    
    createElement("UICorner", {
        Parent = toggleButton,
        CornerRadius = UDim.new(0, 12)
    })
    
    local toggleStroke = createElement("UIStroke", {
        Parent = toggleButton,
        Color = COLORS.STROKE_OFF,
        Thickness = 1.5
    })
    
    local toggleDot = createElement("Frame", {
        Name = "ToggleDot",
        Parent = toggleButton,
        Size = UDIM.DOT_SIZE,
        Position = UDIM.DOT_POS_OFF,
        BackgroundColor3 = COLORS.DOT,
        BorderSizePixel = 0,
        ZIndex = 3
    })
    
    createElement("UICorner", {
        Parent = toggleDot,
        CornerRadius = UDim.new(0, 8)
    })
    
    return frame, toggleButton, toggleDot, toggleStroke
end

-- =========================
-- UI Creation
-- =========================

-- ScreenGui
local ScreenGui = createElement("ScreenGui", {
    Name = "CleanUI",
    ResetOnSpawn = false,
    ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
    Parent = player:WaitForChild("PlayerGui")
})

-- Main Frame
local MainFrame = createElement("Frame", {
    Name = "MainFrame",
    Parent = ScreenGui,
    BackgroundColor3 = COLORS.BACKGROUND,
    BackgroundTransparency = 0.15,
    BorderSizePixel = 0,
    Size = UDim2.fromOffset(226, 304),
    Position = UDim2.fromOffset(280, 20),
    Active = true
})

createElement("UICorner", {
    Parent = MainFrame,
    CornerRadius = UDim.new(0, 10)
})

createElement("UIStroke", {
    Parent = MainFrame,
    Color = COLORS.ACCENT,
    Thickness = 2,
    Transparency = 0.1
})

-- Title Label
createElement("TextLabel", {
    Name = "TitleLabel",
    Parent = MainFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(1, -10, 0, 30),
    Position = UDIM.TITLE_POS,
    Text = "Shadow Script | Lite",
    TextColor3 = COLORS.TEXT,
    TextSize = 16,
    Font = Enum.Font.GothamBold,
    TextStrokeTransparency = 0.8,
    TextStrokeColor3 = COLORS.ACCENT,
    TextXAlignment = Enum.TextXAlignment.Left
})

-- Toggles Container
local TogglesContainer = createElement("Frame", {
    Name = "TogglesContainer",
    Parent = MainFrame,
    BackgroundTransparency = 1,
    Size = UDim2.new(1, 0, 0, 140),
    Position = UDim2.new(0, 0, 0, 40)
})

-- Создание переключателей
local autoFarmFrame, AutoFarmToggle, AutoFarmToggleDot, AutoFarmToggleStroke = 
    createToggle(TogglesContainer, "AutoFarm", "Auto Farm")
autoFarmFrame.Position = UDim2.new(0, 10, 0, 10)

local autoResetFrame, AutoResetToggle, AutoResetToggleDot, AutoResetToggleStroke = 
    createToggle(TogglesContainer, "AutoReset", "Auto Reset")
autoResetFrame.Position = UDim2.new(0, 10, 0, 55)

local antiAFKFrame, AntiAFKToggle, AntiAFKToggleDot, AntiAFKToggleStroke = 
    createToggle(TogglesContainer, "AntiAFK", "Anti-AFK")
antiAFKFrame.Position = UDim2.new(0, 10, 0, 100)

-- =========================
-- Optimized Animation Functions
-- =========================

-- Кэширование анимаций для переключателей
local toggleAnimations = {}

local function getToggleAnimation(toggleButton, toggleDot, toggleStroke, enabled)
    local key = toggleButton.Name .. (enabled and "On" or "Off")
    
    if not toggleAnimations[key] then
        local dotPosition = enabled and UDIM.DOT_POS_ON or UDIM.DOT_POS_OFF
        local toggleColor = enabled and COLORS.TOGGLE_ON or COLORS.TOGGLE_OFF
        local strokeColor = enabled and COLORS.STROKE_ON or COLORS.STROKE_OFF
        
        toggleAnimations[key] = {
            dot = TweenService:Create(toggleDot, TWEEN_INFO.STANDARD, {
                Position = dotPosition
            }),
            toggle = TweenService:Create(toggleButton, TWEEN_INFO.STANDARD, {
                BackgroundColor3 = toggleColor
            }),
            stroke = TweenService:Create(toggleStroke, TWEEN_INFO.STANDARD, {
                Color = strokeColor
            })
        }
    end
    
    return toggleAnimations[key]
end

local function animateToggle(toggleButton, toggleDot, toggleStroke, enabled)
    local animation = getToggleAnimation(toggleButton, toggleDot, toggleStroke, enabled)
    
    animation.dot:Play()
    animation.toggle:Play()
    animation.stroke:Play()
end

-- Оптимизированная функция hover эффекта
local hoverTweens = {}

local function setupHoverEffect(button, isEnabled)
    button.MouseEnter:Connect(function()
        if not isEnabled() then
            local tween = TweenService:Create(button, TWEEN_INFO.FAST, {
                BackgroundColor3 = COLORS.HOVER
            })
            hoverTweens[button] = tween
            tween:Play()
        end
    end)
    
    button.MouseLeave:Connect(function()
        if not isEnabled() then
            local tween = hoverTweens[button]
            if tween then
                tween:Cancel()
            end
            button.BackgroundColor3 = COLORS.TOGGLE_OFF
        end
    end)
end

-- =========================
-- AUTO FARM LOGIC (из первого кода)
-- =========================

-- Состояния
local States = {
    autoResetEnabled = false,
    bag_full = false,
    resetting = false,
    start_position = nil,
    farming = false
}

-- Вспомогательные функции для персонажа
local function getCharacter() 
    return player.Character or player.CharacterAdded:Wait() 
end

local function getHRP() 
    return getCharacter():WaitForChild("HumanoidRootPart") 
end

-- Обработчики событий из первого кода
CoinCollected.OnClientEvent:Connect(function(_, current, max)
    if current == max and not States.resetting and States.autoResetEnabled then
        States.resetting = true
        States.bag_full = true
        
        local hrp = getHRP()
        
        if States.start_position then
            local tween = TweenService:Create(
                hrp, 
                TweenInfo.new(2, Enum.EasingStyle.Linear), 
                {CFrame = States.start_position}
            )
            tween:Play()
            tween.Completed:Wait()
        end
        
        task.wait(0.5)
        player.Character.Humanoid.Health = 0
        player.CharacterAdded:Wait()
        task.wait(1.5)
        
        States.resetting = false
        States.bag_full = false
    end
end)

RoundStart.OnClientEvent:Connect(function()
    States.farming = true
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        States.start_position = player.Character.HumanoidRootPart.CFrame
    end
end)

RoundEnd.OnClientEvent:Connect(function()
    States.farming = false
end)

-- Auto Farm логика из первого кода
local AutoFarmEnabled = false
local AutoFarmRunning = false
local farmConnection

local function get_nearest_coin()
    local hrp = getHRP()
    local closest, dist = nil, math.huge
    
    for _, m in pairs(workspace:GetChildren()) do
        if m:FindFirstChild("CoinContainer") then
            for _, coin in pairs(m.CoinContainer:GetChildren()) do
                if coin:IsA("BasePart") and coin:FindFirstChild("TouchInterest") then
                    local d = (hrp.Position - coin.Position).Magnitude
                    if d < dist then 
                        closest, dist = coin, d 
                    end
                end
            end
        end
    end
    return closest, dist
end

local function StartAutoFarm()
    if AutoFarmRunning then return end
    
    AutoFarmRunning = true
    
    farmConnection = task.spawn(function()
        while AutoFarmEnabled and AutoFarmRunning do
            if States.farming and not States.bag_full then
                local coin, dist = get_nearest_coin()
                if coin then
                    local hrp = getHRP()
                    if dist > AUTO_FARM_SETTINGS.TELEPORT_DISTANCE then
                        hrp.CFrame = coin.CFrame
                    else
                        local tween = TweenService:Create(hrp, TweenInfo.new(dist / AUTO_FARM_SETTINGS.MOVE_SPEED_DIVIDER, Enum.EasingStyle.Linear), {CFrame = coin.CFrame})
                        tween:Play()
                        
                        repeat 
                            task.wait(0.1) 
                        until not coin:FindFirstChild("TouchInterest") or not States.farming or not AutoFarmEnabled
                        
                        tween:Cancel()
                    end
                end
            end
            task.wait(AUTO_FARM_SETTINGS.CHECK_INTERVAL)
        end
    end)
end

local function StopAutoFarm()
    AutoFarmRunning = false
    
    if farmConnection then
        task.cancel(farmConnection)
        farmConnection = nil
    end
end

-- Обновление состояния фарма при событиях
RoundStart.OnClientEvent:Connect(function()
    States.farming = true
    if AutoFarmEnabled and not AutoFarmRunning then
        task.wait(1) -- Ждем загрузку карты
        StartAutoFarm()
    end
end)

RoundEnd.OnClientEvent:Connect(function()
    States.farming = false
    if AutoFarmRunning then
        StopAutoFarm()
    end
end)

-- Обработчики персонажа
player.CharacterAdded:Connect(function()
    task.wait(1)
    
    if AutoFarmEnabled and AutoFarmRunning then
        StopAutoFarm()
        task.wait(0.5)
        if AutoFarmEnabled then
            StartAutoFarm()
        end
    end
    
    States.resetting = false
    States.bag_full = false
end)

-- Обработчики фокуса окна
UserInputService.WindowFocusReleased:Connect(function()
    if AutoFarmEnabled then
        StopAutoFarm()
    end
end)

UserInputService.WindowFocused:Connect(function()
    if AutoFarmEnabled and not AutoFarmRunning and States.farming then
        StartAutoFarm()
    end
end)

-- Anti-AFK из первого кода
player.Idled:Connect(function()
    Services.VirtualUser:CaptureController()
    Services.VirtualUser:ClickButton2(Vector2.new())
end)

-- =========================
-- Optimized Anti-AFK System (Space Only) - из второго кода
-- =========================

local AntiAFKEnabled = false
local AntiAFKConnection = nil
local lastActivityTime = tick()
local lastSpacePressTime = 0
local isPressingSpace = false

-- Функция проверки бездействия игрока
local function isPlayerInactive()
    local inactivityTime = tick() - lastActivityTime
    return inactivityTime >= ANTI_AFK_SETTINGS.INACTIVITY_THRESHOLD
end

-- Функция для нажатия пробела
local function pressSpaceKey()
    if isPressingSpace then return end
    if tick() - lastSpacePressTime < ANTI_AFK_SETTINGS.DEBOUNCE_TIME then return end
    
    isPressingSpace = true
    
    local success, err = pcall(function()
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Space, false, game)
        task.wait(ANTI_AFK_SETTINGS.SPACE_PRESS_DURATION)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Space, false, game)
        
        lastSpacePressTime = tick()
        lastActivityTime = tick()
    end)
    
    isPressingSpace = false
end

-- Основная функция проверки и выполнения Anti-AFK
local function checkAntiAFK()
    if not AntiAFKEnabled then return end
    
    if isPlayerInactive() then
        pressSpaceKey()
    end
end

-- Функция отслеживания активности игрока
local function trackPlayerActivity()
    local function updateActivity()
        lastActivityTime = tick()
    end
    
    UserInputService.InputBegan:Connect(updateActivity)
    UserInputService.InputChanged:Connect(updateActivity)
    
    UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            updateActivity()
        end
    end)
    
    if player.Character then
        player.Character:GetPropertyChangedSignal("PrimaryPart"):Connect(updateActivity)
    end
end

-- Функция запуска Anti-AFK
local function startAntiAFK()
    if AntiAFKConnection then
        AntiAFKConnection:Disconnect()
    end
    
    lastActivityTime = tick()
    lastSpacePressTime = 0
    
    trackPlayerActivity()
    
    AntiAFKConnection = RunService.Heartbeat:Connect(function(deltaTime)
        if tick() - lastSpacePressTime > ANTI_AFK_SETTINGS.CHECK_INTERVAL then
            checkAntiAFK()
        end
    end)
end

-- Функция остановки Anti-AFK
local function stopAntiAFK()
    if AntiAFKConnection then
        AntiAFKConnection:Disconnect()
        AntiAFKConnection = nil
    end
    
    isPressingSpace = false
end

-- =========================
-- Optimized Toggle States with Sound
-- =========================

-- Auto Farm toggle
local function toggleAutoFarm()
    AutoFarmEnabled = not AutoFarmEnabled
    
    playClickSound()
    
    animateToggle(AutoFarmToggle, AutoFarmToggleDot, AutoFarmToggleStroke, AutoFarmEnabled)
    
    if AutoFarmEnabled then
        if States.farming then
            task.wait(0.5)
            StartAutoFarm()
        else
            warn("Auto Farm will start when round begins")
        end
    else
        StopAutoFarm()
    end
end

AutoFarmToggle.MouseButton1Click:Connect(toggleAutoFarm)
setupHoverEffect(AutoFarmToggle, function() return AutoFarmEnabled end)

-- Auto Reset toggle
local function toggleAutoReset()
    States.autoResetEnabled = not States.autoResetEnabled
    
    playClickSound()
    
    animateToggle(AutoResetToggle, AutoResetToggleDot, AutoResetToggleStroke, States.autoResetEnabled)
    
    -- Сохраняем текущую позицию как стартовую при включении
    if States.autoResetEnabled then
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            States.start_position = player.Character.HumanoidRootPart.CFrame
        end
    end
end

AutoResetToggle.MouseButton1Click:Connect(toggleAutoReset)
setupHoverEffect(AutoResetToggle, function() return States.autoResetEnabled end)

-- Anti-AFK toggle
local function toggleAntiAFK()
    AntiAFKEnabled = not AntiAFKEnabled
    
    playClickSound()
    
    animateToggle(AntiAFKToggle, AntiAFKToggleDot, AntiAFKToggleStroke, AntiAFKEnabled)
    
    if AntiAFKEnabled then
        startAntiAFK()
    else
        stopAntiAFK()
    end
end

AntiAFKToggle.MouseButton1Click:Connect(toggleAntiAFK)
setupHoverEffect(AntiAFKToggle, function() return AntiAFKEnabled end)

-- =========================
-- Optimized Drag System
-- =========================

local dragging = false
local dragInput
local dragStart
local startPos

local function updateDrag(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(
        startPos.X.Scale,
        startPos.X.Offset + delta.X,
        startPos.Y.Scale,
        startPos.Y.Offset + delta.Y
    )
end

MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or 
       input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or
       input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        updateDrag(input)
    end
end)

-- Инициализация при запуске
warn("Shadow Script Lite loaded successfully!")

-- Очистка при выходе
game:GetService("Players").PlayerRemoving:Connect(function(leavingPlayer)
    if leavingPlayer == player then
        StopAutoFarm()
        stopAntiAFK()
    end
end)
